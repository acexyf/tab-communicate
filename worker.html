<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Webworker</title>
  <link rel="stylesheet" href="/public/style.css">
</head>


<body>
  <div id="app">
    <div class="box">
      <div class="item header">
        <div class="index"></div>
        <div class="name">歌曲标题</div>
        <div class="time">时长</div>
        <div class="singer">歌手</div>
        <div class="album">专辑</div>
      </div>
      <template v-for="(item, index) in list">
        <div :class="['item','music',activeIndex == index ? 'active':'']" @click="clickMusic(item, index)" :key="index">
          <div class="index">{{index+1}}</div>
          <div class="name">{{item.name}}</div>
          <div class="time">{{item.time}}</div>
          <div class="singer">{{item.singer}}</div>
          <div class="album">{{item.album}}</div>
        </div>
      </template>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios"></script>
  <script src="https://cdn.jsdelivr.net/npm/qs@6.9.4/dist/qs.min.js"></script>

  <script>
    new Vue({
      el: '#app',
      data() {
        return {
          list: [],
          activeIndex: -1,
          page_id: '0',
          sw: {},
        }
      },
      mounted() {

        let timestamp = new Date().getTime()
        this.page_id = timestamp + ''
        this.sw = new SharedWorker('/public/shared.js');
        const {
          id = '1'
        } = Qs.parse(window.location.search, {
          ignoreQueryPrefix: true
        })

        axios({
          url: '/api/list',
          params: {
            id,
          }
        }).then((res) => {
          return res.data
        }).then((res) => {
          console.log(res)
          const {
            list
          } = res
          this.list = list
        })

        this.sw.port.onmessage = (ev) => {
          console.log(ev)

          let {
            type,
            data
          } = ev.data
          if (type == 'get' && !!data) {

            let parse = data

            let {
              list,
              page_id
            } = this
            let activeIndex = -1
            list.map((item, index) => {
              if (item.name == parse.name && parse.page_id == page_id) {
                activeIndex = index
              }
            })
            this.activeIndex = activeIndex

          }

        }
        this.sw.port.start()
        setInterval(() => {
          this.sw.port.postMessage({
            type: 'get',
            data: null
          })
        }, 1000)
      },
      methods: {
        clickMusic(item, index) {
          console.log(item, 'item')
          this.activeIndex = index

          let {
            page_id
          } = this
          item = Object.assign({
            page_id,
          }, item)

          // localStorage.setItem('music', JSON.stringify(item))


          this.sw.port.postMessage({
            type: 'set',
            data: item
          })
        }
      }

    })
  </script>

  <script>
    // var sw = new SharedWorker('/public/shared.js');
    // document.querySelector('#btn').addEventListener('click',function(){
    //     sw.port.onmessage = function(ev){
    //         console.log(ev.data)
    //     }
    //     sw.port.start()
    //     sw.port.postMessage('click')
    // })
  </script>
</body>

</html>